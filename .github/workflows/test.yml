name: Build and run image with QEMU

on:
  push:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Install depends
        run: |
          sudo apt update
          sudo apt install gcc-14-x86-64-linux-gnu  \
                      binutils-x86-64-gnu      \
                      gdisk dosfstools grub-pc \
                      qemu-system pcre2-utils

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy default config
        run: make config

      - name: Build binaries
        run: make CC=/usr/bin/x86_64-linux-gnu-gcc-14 \
                  LD=/usr/bin/x86_64-gnu-ld           \
                  AR=/usr/bin/x86_64-gnu-ar

      - name: Build image
        run: make image

      - name: Run with QEMU
        run: |
          tail -n5 *.log
          (./scripts/qemu.sh --log --no-display &> /dev/null &)
          sleep 20 && killall -9 qemu-system-x86_64

      - name: Run test script
        run: make test
